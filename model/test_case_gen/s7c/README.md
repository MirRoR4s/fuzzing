# S7Communication 协议

## 前言

由于 S7C 协议封装在 TPKT 和 COTP 协议层中，所以重写了 TCPSocketConnection 类在发送模糊测试数据时将数据封装在这两个协议层中。


<!-- 1. 对于 S7C 协议，数据包之间的结构大致相同，为了减少代码量，希望把首部字段设置成公共的，不过这样会导致无法接收用户的布尔列表了。所以我们需要一种方法来在定义完毕用例的结构之后，还可以对用例中的字段变异规则进行修改。

解决方案：

```python
a = S7CommunicationGenerator().header
print(a.stack[0].fuzzable)
a.stack[0]._fuzzable=True
print(a.stack[0].fuzzable)
# False
# True
> 以上方法破坏了封装性，不是一个好的方法。
``` -->


两步走定义该协议的原语：

1. 在一个公共的函数中定义首部
2. 在各自的函数中定义参数


## 模糊测试对象构建

在 Boofuzz 中，模糊测试对象指的是 Request 对象，我们可以通过定义 Boofuzz 自带的原语类对象来生成 Request 对象。

### Set Up Communication

下面讲述建立通信数据包的构建思路，要注意的是，在发送该数据包之前必须先发送 CR TPDU 数据包，否则 PLC 会立即断开连接。

首部中存在两个长度字段，分别是参数长度和数据长度，在这两个长度字段之后跟着的就是参数和数据。建立通信数据包是没有数据的，所以数据长度字段的值为零。对于参数长度，建立通信数据包有8个固定参数，共占用8字节，所以参数长度字段值固定为8。

~~对于建立通信数据包，值得模糊测试的点可能在于 PDU 长度。~~

COTP 连接数据包的 scapy 定义如何处理重复的三个？


### Read Var

读取变量数据包能够读取的信息有很多，可以通过控制 db number 和 area 以及 address 来读取你想要的信息。

读取变量数据包无数据，所以数据长度字段值为零。在具体的代码实现时要注意的点如下：

1. 注意首部中的参数长度字段值要和后续的参数长度一致，否则 PLC 会给出错误。


### Read SZL

读取系统状态列表，注意首部中的 ROSCTR 要改成 Userdata



