# 漏洞挖掘系统开发文档

## 用户管理

用户实体拥有的属性是：

1. 名称（username）：用户的名称。
2. 身份标识符（id）：用户的唯一标识符。
3. 密码（password）：用于登录，存储明文密码的哈希值。
4. 邮箱（email）：用于密码找回。
5. 测试用例组（test_case_groups）：测试用例组由多个测试用例组成。一个用户可拥有多个测试用例组，同时一个测试用例组唯一对应一个用户。
6. 测试套件（test_suites）：测试套件由多个测试用例构成。一个用户可拥有多个测试套件，一个测试套件由多个测试用例组成。
7. 角色（role）：标识用户在系统中的权限等级。
8. 禁用（disabled）：标识用户是否被禁用，用于多次登录错误的情况。

### 用户注册

- 用户输入用户名（**username**）、密码（**password**）、确认密码、邮箱（**email**）完成注册。

> 前端校验用户输入的两个密码是否一致，最后只将第一个密码传入（无论两个密码是否一致）。

1. 根据 username 查询 Users 表是否已存在该用户，存在返回错误。
2. 否则将用户信息（role 为 normal，disable 为 False，test_case_groups 和 test_suites 为空）插入 Users 表。
3. 日志记录用户注册操作。
4. 向客户端响应注册成功。

### 用户登录

- 用户传入 `username` 和密码 `password` 完成登录。

1. 根据 username 查询数据库判断用户是否存在，不存在则返回用户不存在。
2. 否则获取该用户的 password 密码（以哈希形式存储），同时将传入的密码进行哈希，最后比较两个哈希后的密码，不相等则返回账号或密码错误。
3. 否则创建 JWT，其中包含了 username。
4. 向客户端返回 JWT，并提示登录成功。

### 用户信息查询

1. jwt 身份认证，提取用户名称。认证失败抛出异常。
2. 根据名称 username 查询数据库中是否存在对应用户，不存在抛出异常。
3. 否则获取该用户的 id、role、username 等信息。
4. 将上述信息返回客户端。

## 模糊测试管理

模糊测试用例实体拥有的属性是：

1. 名称（name）：测试用例的名称。
2. 测试用例 id（test_case_id）：测试用例的唯一标识符。
3. 描述（desc）：对测试用例的描述。
4. 长度（size）：指示测试用例占据的比特/字节数。
5. 单位（unit）：比特或字节
6. 默认值（default_value）：测试用例的默认值。
7. 字节顺序（endian）：测试用例的字节顺序，大端用 `>` 表示，小端用 `<` 表示。
8. 变异规则（fuzzable）：表示是否要对用例进行模糊测试，用 `True` 或 `False` 表示。
9. 父节点（parent_id）：用于测试用例的嵌套

### 系统用例库定义

需求：将系统支持的各个协议的测试用例组返回给客户端。

考虑在一个单独的 py 文件中定义一个以协议名为键，测试用例组为值的字典。其中测试用例组本身是一个列表，包含了多个测试用例。之后将该字典以 JSON 的形式返回即可。

### 测试用例库读取

- 读取测试用例库 = 读取用户的全部测试用例组

1. 利用 `JWT` 判断用户是否登录。如果用户未登录或者登录 token 已过期，那么响应未登录并跳转登录页面。
2. 否则从 `JWT` 中提取用户 id，以此为条件从 TestCaseGroup 表查询特定的测试用例组。
3. 返回系统默认用例组和用户自定义用例组

### 测试用例组创建

传入组名（str）创建测试用例组

1. 利用 `token` 判断用户是否登录。如果用户未登录或者登录 token 已过期，那么响应未登录并跳转登录页面。
2. 否则根据组名、用户 id、向测试用例组表 test_case_groups 插入一条记录（记录本身的 id 初始为 0，自增）。
3. 向客户端响应创建成功

### 自定义测试用例

传入：

1. 测试用例组名
2. 测试用例名称
3. 测试用例描述
4. 长度
5. 单位
6. 默认值
7. 端序
8. 变异规则
9. 父节点 id（可选）

操作：

1. 根据测试用例组名查询 test_case_groups 表中特定用例组的 id。
2. 根据上述 1-9 步的信息结合查询出的特定用例组的 id 向测试用例表 fuzzy_test_cases 插入一条记录（测试套件 id 为空）。
3. 响应自定义测试用例成功。

### 测试套件设置

场景描述：用户从测试用例库中任选多个测试用例，然后将这些用例加入到测试套件并放入套件库中。（套件库也称为测试套件模板库）

设置测试套件需要的信息分别是：

1. 测试用例组名称
2. 测试用例
3. 套件名称
4. 套件描述

**注意：仅当用户在测试套件页面点击了保存套件按钮时，才触发此路由。**

操作：

1. JWT 鉴权。
2. 根据套件名称和套件描述向 TestSuites 表插入一行。（id 自增且初始值为零，user_id 则是当前用户的）
3. 根据测试用例**组**的名称查询 TestCaseGroups 表获取指定测试用例组的 id。
4. 再根据获取到的**组 id** 查询 FuzzyTestCase 表获取特定的测试用例。
5. 查询刚向 TestSuites 表中插入的行记录的 id
6. 将得到的测试用例的 test_suite_id 修改为刚得到的 id。

### 测试套件库读取

- 传入测试套件的名称，获取该套件下的所有测试用例。

操作：

1. JWT 鉴权。
2. 根据套件名查询 TestSuites 表获取套件 id。
3. 根据套件 id 查询 FuzzyTestCase 表获取多行测试用例的名称
4. 将这些名称打包成 JSON 格式返回

### 连接测试用例

- 选择测试套件模板库下的某个测试套件，获取该套件下所有测试用例，建立各用例间的连接关系
- 传入测试套件名称
- 传入连接关系逻辑

操作：

1. JWT 鉴权。
2. 根据测试套件名称查询 TestSuites 表获取套件 id。
3. 根据套件 id 查询 FuzzTestCase 表获取多行测试用例。
4. 对每个测试用例，依据其各项属性，定义 Boofuzz 原语，并构造 Request 对象。
5. 根据连接关系逻辑连接 Request 对象。
6. 进行模糊测试。



## 日志管理

记录用户的操作信息

## 辅助工具

1. SQLite 可视化工具：推荐使用一个名为 SQLite Viewer 的 Vs Code 扩展。
